<!doctype html>

<html>
	<head>
		<style>
		#video {
			border: 1px solid black;
			width: 320px;
			height: 240px;
		}

		#photo {
			border: 1px solid black;
			width: 320px;
			height: 240px;
		}

		#canvas {
			display: none;
		}

		.camera {
			width: 340px;
			display: inline-block;
		}

		.output {
			width: 340px;
			display: inline-block;
		}

		#startbutton {
			display: block;
			position: relative;
			margin-left: auto;
			margin-right: auto;
			bottom: 36px;
			padding: 5px;
			background-color: #6a67ce;
			border: 1px solid rgba(255, 255, 255, 0.7);
			font-size: 14px;
			color: rgba(255, 255, 255, 1.0);
			cursor: pointer;
		}

		#postbutton {
			display: block;
			position: relative;
			margin-left: auto;
			margin-right: auto;
			bottom: 36px;
			padding: 5px;
			background-color: #6a67ce;
			border: 1px solid rgba(255, 255, 255, 0.7);
			font-size: 14px;
			color: rgba(255, 255, 255, 1.0);
			cursor: pointer;
		}

		.contentarea {
			font-size: 16px;
			font-family: Arial;
			text-align: center;
		}
		</style>
		<title>Telephone Number Search</title>
	</head>
	<body>
		<div class="contentarea">
			<h1>
				Welcome To Telephone Directory People Finder
			</h1>
			<div class="camera">
				<video id="video">Video stream not available.</video>
			</div>
			<div><button id="startbutton">Take photo</button></div>
			<canvas id="canvas"></canvas>
			<div class="output">
				<img id="photo" alt="The screen capture will appear in this box.">
			</div>
			<div><button id="postbutton" onclick="showLoading()">Post photo</button></div>
		</div>		
		<script>
			(function() {

				var width = 320; // We will scale the photo width to this
				var height = 0; // This will be computed based on the input stream

				var streaming = false;

				var video = null;
				var canvas = null;
				var photo = null;
				var startbutton = null;

				function startup() {
					video = document.getElementById('video');
					canvas = document.getElementById('canvas');
					photo = document.getElementById('photo');
					startbutton = document.getElementById('startbutton');
					postBtn = document.getElementById('postbutton');

					navigator.mediaDevices.getUserMedia({
							video: true,
							audio: false
						})
						.then(function(stream) {
							video.srcObject = stream;
							video.play();
						})
						.catch(function(err) {
							console.log("An error occurred: " + err);
						});

					video.addEventListener('canplay', function(ev) {
						if (!streaming) {
							height = video.videoHeight / (video.videoWidth / width);

							if (isNaN(height)) {
								height = width / (4 / 3);
							}

							video.setAttribute('width', width);
							video.setAttribute('height', height);
							canvas.setAttribute('width', width);
							canvas.setAttribute('height', height);
							streaming = true;
						}
					}, false);

					startbutton.addEventListener('click', function(ev) {
						takepicture();
						ev.preventDefault();
					}, false);

					postBtn.addEventListener('click', function(ev) {
						postPicture();
						ev.preventDefault();
					}, false);

					clearphoto();
				}


				function clearphoto() {
					var context = canvas.getContext('2d');
					context.fillStyle = "#AAA";
					context.fillRect(0, 0, canvas.width, canvas.height);

					var data = canvas.toDataURL('image/png');
					photo.setAttribute('src', data);
				}

				function takepicture() {
					var context = canvas.getContext('2d');
					if (width && height) {
						canvas.width = width;
						canvas.height = height;
						context.drawImage(video, 0, 0, width, height);

						var data = canvas.toDataURL('image/png');
						photo.setAttribute('src', data);
					} else {
						clearphoto();
					}
				}

				function postPicture() {
					var img = photo.src;
					var xhr = new XMLHttpRequest();
					xhr.open('POST', 'upload', true);					
					xhr.setRequestHeader('Content-type', 'application/json;charset=UTF-8');
					xhr.onload = function () {
						//Render result page while processing completed
						window.location.assign('/result');
						console.log(this.responseText);
					};
					//Post image to server for processing
					xhr.send(JSON.stringify({'imgData': img}));
				}
				window.addEventListener('load', startup, false);
			})();
			function showLoading() {    
			if (document.querySelector("#pleaseWaitDialog") == null) {
				var modalLoading = '<div class="modal" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false" role="dialog">\
					<div class="modal-dialog">\
						<div class="modal-content">\
							<div class="modal-header">\
								<h4 class="modal-title">Please wait...</h4>\
							</div>\
							<div class="modal-body">\
								<div class="progress">\
								<div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar"\
								aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width:100%; height: 40px">\
								</div>\
								</div>\
							</div>\
						</div>\
					</div>\
				</div>';
				$(document.body).append(modalLoading);
			}
		
			$("#pleaseWaitDialog").modal("show");
		}

		</script>
	</body>
</html>